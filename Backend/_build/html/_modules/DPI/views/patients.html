

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DPI.views.patients &mdash; Gestionnaire du dossier patient informatisé 1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=29a6c3e3"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Gestionnaire du dossier patient informatisé
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Gestionnaire du dossier patient informatisé</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">DPI.views.patients</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for DPI.views.patients</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..serializers</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">status</span>
<span class="kn">import</span> <span class="nn">qrcode</span>
<span class="kn">import</span> <span class="nn">qrcode.image.svg</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">django.views</span> <span class="kn">import</span> <span class="n">View</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">IsAuthenticated</span>
<span class="kn">from</span> <span class="nn">reportlab.lib.pagesizes</span> <span class="kn">import</span> <span class="n">letter</span>
<span class="kn">from</span> <span class="nn">reportlab.pdfgen</span> <span class="kn">import</span> <span class="n">canvas</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">JsonResponse</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_exempt</span>


<span class="c1">#----------CREATION DU COMPTE PATIENT &amp; D&#39;UN DOSSIER PATIENT INFORMATISE ASSOCIE----------</span>
<div class="viewcode-block" id="CreatePatientAccountAndDossierAPIView">
<a class="viewcode-back" href="../../../docs/DPI.views.html#DPI.views.patients.CreatePatientAccountAndDossierAPIView">[docs]</a>
<span class="k">class</span> <span class="nc">CreatePatientAccountAndDossierAPIView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API View to handle the creation of a patient account and associated medical file (DPI).</span>

<span class="sd">    This view processes a POST request to create a new patient account along with their medical file (Dossier Patient Informatique - DPI).</span>
<span class="sd">    The process involves:</span>
<span class="sd">    - Verifying the existence of a treating doctor (`medecin_traitant`) by email.</span>
<span class="sd">    - Creating a user for the patient using their email and password.</span>
<span class="sd">    - Creating a DPI with relevant information such as social security number, birth date, address, etc.</span>
<span class="sd">    - Creating a `ComptePatient` (patient account) with the user and DPI details.</span>

<span class="sd">    If any step fails, appropriate error handling is performed, and the created resources (user or DPI) are deleted to ensure data integrity.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The HTTP request object containing the patient data in JSON format.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Response:</span>
<span class="sd">            - On success: A JSON response with a success message and HTTP 201 status.</span>
<span class="sd">            - On failure:</span>
<span class="sd">                - If the treating doctor is not found: A JSON response with an error message and HTTP 404 status.</span>
<span class="sd">                - If the DPI is invalid: A JSON response with the validation errors and HTTP 400 status.</span>
<span class="sd">                - If the patient account creation fails: A JSON response with validation errors and HTTP 400 status.</span>
<span class="sd">                - On unexpected errors: A JSON response with the error message and HTTP 500 status.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="CreatePatientAccountAndDossierAPIView.post">
<a class="viewcode-back" href="../../../docs/DPI.views.html#DPI.views.patients.CreatePatientAccountAndDossierAPIView.post">[docs]</a>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># Extraire les données du formulaire JSON</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Vérifier si le médecin traitant existe</span>
            <span class="n">medecin_traitant</span> <span class="o">=</span> <span class="n">CompteMedecin</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doctor_traitant&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">CompteMedecin</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Médecin traitant non trouvé.&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Créer l&#39;utilisateur associé</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
                <span class="n">username</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">),</span>
                <span class="n">email</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">),</span>
                <span class="n">password</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mot_de_passe&#39;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Créer le dossier patient (DPI)</span>
            <span class="n">dpi_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;numeroSecuriteSociale&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_securite_sociale&quot;</span><span class="p">),</span>
                <span class="s2">&quot;dateDeNaissance&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date_de_naissance&quot;</span><span class="p">),</span>
                <span class="s2">&quot;adresse&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;adresse&quot;</span><span class="p">),</span>
                <span class="s2">&quot;telephone&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_telephone&quot;</span><span class="p">),</span>
                <span class="s2">&quot;mutuelle&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mutuelle&quot;</span><span class="p">),</span>
                <span class="s2">&quot;idMedecinTraitant&quot;</span><span class="p">:</span> <span class="n">medecin_traitant</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                <span class="s2">&quot;personneAcontacter&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;personne_a_contacter&quot;</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">dpi_serializer</span> <span class="o">=</span> <span class="n">DPISerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dpi_data</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">dpi_serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="n">dpi</span> <span class="o">=</span> <span class="n">dpi_serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="c1"># Créer le compte patient</span>
                <span class="n">patient_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;nomComplet&quot;</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nomComplet&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;motDePasse&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mot_de_passe&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;dossierPatient&quot;</span><span class="p">:</span> <span class="n">dpi</span><span class="o">.</span><span class="n">numeroSecuriteSociale</span>
                <span class="p">}</span>
                <span class="n">patient_serializer</span> <span class="o">=</span> <span class="n">ComptePatientSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">patient_data</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">patient_serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                    <span class="n">patient_serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Compte patient et dossier créés avec succès.&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Si le compte patient n&#39;est pas valide, supprimer le DPI et l&#39;utilisateur</span>
                    <span class="n">dpi</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">patient_serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Si le DPI n&#39;est pas valide, supprimer l&#39;utilisateur</span>
                <span class="n">user</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">dpi_serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span></div>
</div>

        

<span class="c1">#----------RECHERCHE D&#39;UN DOSSIER PATIENT INFORMATISE PAR LE NUMERO DE SECURITE SOCIALE----------</span>
<div class="viewcode-block" id="RecherchePatientView">
<a class="viewcode-back" href="../../../docs/DPI.views.html#DPI.views.patients.RecherchePatientView">[docs]</a>
<span class="k">class</span> <span class="nc">RecherchePatientView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API View to search for a patient&#39;s medical file (Dossier Patient Informatisé - DPI) </span>
<span class="sd">    using the patient&#39;s social security number (Numéro de Sécurité Sociale).</span>

<span class="sd">    This view processes a POST request where the user provides the patient&#39;s social security number, </span>
<span class="sd">    and the system searches for the corresponding medical file and patient account in the database.</span>

<span class="sd">    The flow is as follows:</span>
<span class="sd">    1. Retrieve the patient&#39;s social security number from the request.</span>
<span class="sd">    2. Search for the DPI associated with that number.</span>
<span class="sd">    3. Search for the patient account linked to the found DPI.</span>
<span class="sd">    4. Return both the patient account and DPI details in the response.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The HTTP request object containing the patient&#39;s social security number.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Response:</span>
<span class="sd">            - On success: A JSON response containing both the patient and DPI data with HTTP 200 status (OK).</span>
<span class="sd">            - On failure:</span>
<span class="sd">                - If the social security number is not provided: A JSON response with an error message and HTTP 400 status (Bad Request).</span>
<span class="sd">                - If the DPI is not found: A JSON response with an error message and HTTP 404 status (Not Found).</span>
<span class="sd">                - If the patient account is not found: A JSON response with an error message and HTTP 404 status (Not Found).</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="RecherchePatientView.post">
<a class="viewcode-back" href="../../../docs/DPI.views.html#DPI.views.patients.RecherchePatientView.post">[docs]</a>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># Récupérer le numéro de sécurité sociale depuis le corps de la requête</span>
        <span class="n">numero_securite_sociale</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numero_securite_sociale&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numero_securite_sociale</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Le numéro de sécurité sociale est requis.&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Recherche du dossier patient par numéro de sécurité sociale</span>
            <span class="n">dpi</span> <span class="o">=</span> <span class="n">DPI</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">numeroSecuriteSociale</span><span class="o">=</span><span class="n">numero_securite_sociale</span><span class="p">)</span>
            
            <span class="c1"># Recherche du compte patient associé</span>
            <span class="n">compte_patient</span> <span class="o">=</span> <span class="n">ComptePatient</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dossierPatient</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
            
            <span class="c1"># Sérialisation des données</span>
            <span class="n">patient_serializer</span> <span class="o">=</span> <span class="n">ComptePatientSerializer</span><span class="p">(</span><span class="n">compte_patient</span><span class="p">)</span>
            <span class="n">dpi_serializer</span> <span class="o">=</span> <span class="n">DPISerializer</span><span class="p">(</span><span class="n">dpi</span><span class="p">)</span>
            
            <span class="c1"># Retour des données combinées</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s2">&quot;patient&quot;</span><span class="p">:</span> <span class="n">patient_serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="s2">&quot;dossier_patient&quot;</span><span class="p">:</span> <span class="n">dpi_serializer</span><span class="o">.</span><span class="n">data</span>
            <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        
        <span class="k">except</span> <span class="n">DPI</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Dossier patient introuvable.&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ComptePatient</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Compte patient introuvable.&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span></div>
</div>

        
<span class="c1">#----------RECHERCHE D&#39;UN DOSSIER PATIENT INFORMATISE PAR QR CODE----------</span>
<div class="viewcode-block" id="GenerateQRCodeView">
<a class="viewcode-back" href="../../../docs/DPI.views.html#DPI.views.patients.GenerateQRCodeView">[docs]</a>
<span class="k">class</span> <span class="nc">GenerateQRCodeView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API view to generate a QR code containing the patient&#39;s medical file (Dossier Patient Informatique - DPI) </span>
<span class="sd">    details based on the social security number (Numéro de Sécurité Sociale).</span>

<span class="sd">    This view processes a GET request where the user provides the patient&#39;s social security number, </span>
<span class="sd">    and the system generates a QR code containing specific patient information.</span>

<span class="sd">    The flow is as follows:</span>
<span class="sd">    1. Retrieve the patient&#39;s DPI based on the provided social security number.</span>
<span class="sd">    2. Generate a QR code that includes the following patient information:</span>
<span class="sd">        - Dossier Patient number</span>
<span class="sd">        - Contact name (personneAcontacter)</span>
<span class="sd">        - Contact phone number (telephone)</span>
<span class="sd">    3. Return the generated QR code as an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The HTTP request object.</span>
<span class="sd">        numero_securite_sociale (str): The social security number (Numéro de Sécurité Sociale) of the patient </span>
<span class="sd">                                       to generate the QR code.</span>

<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse:</span>
<span class="sd">            - On success: The generated QR code image in PNG format with HTTP 200 status.</span>
<span class="sd">            - On failure: </span>
<span class="sd">                - If the DPI corresponding to the provided social security number is not found, an HTTP 404 error is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="GenerateQRCodeView.get">
<a class="viewcode-back" href="../../../docs/DPI.views.html#DPI.views.patients.GenerateQRCodeView.get">[docs]</a>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">numero_securite_sociale</span><span class="p">):</span>
        <span class="c1"># Récupération du DPI correspondant</span>
        <span class="n">dpi</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">DPI</span><span class="p">,</span> <span class="n">numeroSecuriteSociale</span><span class="o">=</span><span class="n">numero_securite_sociale</span><span class="p">)</span>
        
        <span class="c1"># Génération du contenu pour le QR code</span>
        <span class="n">qr_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Dossier Patient: </span><span class="si">{</span><span class="n">dpi</span><span class="o">.</span><span class="n">numeroSecuriteSociale</span><span class="si">}</span><span class="s2">, Nom: </span><span class="si">{</span><span class="n">dpi</span><span class="o">.</span><span class="n">personneAcontacter</span><span class="si">}</span><span class="s2">, Téléphone: </span><span class="si">{</span><span class="n">dpi</span><span class="o">.</span><span class="n">telephone</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Génération du QR code</span>
        <span class="n">qr</span> <span class="o">=</span> <span class="n">qrcode</span><span class="o">.</span><span class="n">QRCode</span><span class="p">(</span>
            <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">error_correction</span><span class="o">=</span><span class="n">qrcode</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">ERROR_CORRECT_L</span><span class="p">,</span>
            <span class="n">box_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">border</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">qr</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">qr_content</span><span class="p">)</span>
        <span class="n">qr</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Génération de l&#39;image</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">qr</span><span class="o">.</span><span class="n">make_image</span><span class="p">(</span><span class="n">fill_color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">back_color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;PNG&quot;</span><span class="p">)</span>
        <span class="n">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Retourne l&#39;image en réponse HTTP</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;image/png&quot;</span><span class="p">)</span></div>
</div>

    
<span class="c1">#----------RECUPERATION DU NOM DU MEDECIN TRAITANT A PARTIR DU NSS PATIENT----------</span>
<div class="viewcode-block" id="MedecinTraitantAPIView">
<a class="viewcode-back" href="../../../docs/DPI.views.html#DPI.views.patients.MedecinTraitantAPIView">[docs]</a>
<span class="k">class</span> <span class="nc">MedecinTraitantAPIView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API view to retrieve the treating doctor (Médecin Traitant) associated with a given social security number (NSS).</span>

<span class="sd">    This view processes a GET request where the user provides the patient&#39;s social security number (NSS),</span>
<span class="sd">    and the system retrieves the treating doctor associated with that number from the patient’s medical file (Dossier Patient Informatique - DPI).</span>

<span class="sd">    The flow is as follows:</span>
<span class="sd">    1. Retrieve the DPI (patient’s medical file) based on the provided social security number (NSS).</span>
<span class="sd">    2. Retrieve the treating doctor (Médecin Traitant) associated with the DPI.</span>
<span class="sd">    3. Return the treating doctor&#39;s details including:</span>
<span class="sd">        - First name (prenom)</span>
<span class="sd">        - Last name (nom)</span>
<span class="sd">        - Email address (email)</span>
<span class="sd">        - Specialty (specialite)</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The HTTP request object.</span>
<span class="sd">        nss (str): The social security number (Numéro de Sécurité Sociale) of the patient whose treating doctor is to be fetched.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Response:</span>
<span class="sd">            - On success: A JSON object with the treating doctor&#39;s details, HTTP 200 status.</span>
<span class="sd">            - On failure:</span>
<span class="sd">                - If no DPI is found for the provided NSS: HTTP 404 status with an error message.</span>
<span class="sd">                - If no treating doctor is associated with the patient: HTTP 404 status with an error message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="MedecinTraitantAPIView.get">
<a class="viewcode-back" href="../../../docs/DPI.views.html#DPI.views.patients.MedecinTraitantAPIView.get">[docs]</a>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">nss</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Rechercher le DPI correspondant au NSS</span>
            <span class="n">dpi</span> <span class="o">=</span> <span class="n">DPI</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">numeroSecuriteSociale</span><span class="o">=</span><span class="n">nss</span><span class="p">)</span>
            
            <span class="c1"># Récupérer l&#39;email du médecin traitant associé</span>
            <span class="n">medecin_traitant_email</span> <span class="o">=</span> <span class="n">dpi</span><span class="o">.</span><span class="n">idMedecinTraitant</span>
            
            <span class="c1"># Vérifier si un email de médecin est fourni</span>
            <span class="k">if</span> <span class="n">medecin_traitant_email</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Rechercher le médecin avec l&#39;email dans le modèle Medecin</span>
                    <span class="n">medecin_traitant</span> <span class="o">=</span> <span class="n">CompteMedecin</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">medecin_traitant_email</span><span class="p">)</span>
                    
                    <span class="c1"># Préparer les données du médecin traitant</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;nomComplet&quot;</span><span class="p">:</span><span class="n">medecin_traitant</span><span class="o">.</span><span class="n">nomComplet</span><span class="p">,</span>
                        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">medecin_traitant</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                        <span class="s2">&quot;specialite&quot;</span><span class="p">:</span> <span class="n">medecin_traitant</span><span class="o">.</span><span class="n">specialite</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">CompteMedecin</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                    <span class="c1"># Si le médecin n&#39;existe pas dans la base de données</span>
                    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Médecin traitant introuvable.&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Aucun médecin traitant associé.&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>
        
        <span class="k">except</span> <span class="n">DPI</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="c1"># Si le DPI pour le NSS n&#39;existe pas</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Dossier patient introuvable pour ce NSS.&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DPIViewSet">
<a class="viewcode-back" href="../../../docs/DPI.views.html#DPI.views.patients.DPIViewSet">[docs]</a>
<span class="k">class</span> <span class="nc">DPIViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A viewset for viewing and editing `DPI` (Dossier Patient Informatique) instances.</span>

<span class="sd">    This viewset provides the standard actions for managing `DPI` records, including:</span>
<span class="sd">    - Listing all DPI records.</span>
<span class="sd">    - Retrieving a specific DPI record by its ID.</span>
<span class="sd">    - Creating new DPI records.</span>
<span class="sd">    - Updating existing DPI records.</span>
<span class="sd">    - Deleting DPI records.</span>

<span class="sd">    The `DPIViewSet` utilizes the `DPISerializer` to serialize and deserialize data for the `DPI` model.</span>

<span class="sd">    Args:</span>
<span class="sd">        queryset (QuerySet): A queryset representing all `DPI` instances (`DPI.objects.all()`).</span>
<span class="sd">        serializer_class (Serializer): The serializer class used for the `DPI` model (`DPISerializer`).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Response:</span>
<span class="sd">            - GET request: Returns a list of `DPI` records or a single `DPI` record in detail.</span>
<span class="sd">            - POST request: Creates a new `DPI` record.</span>
<span class="sd">            - PUT/PATCH request: Updates an existing `DPI` record.</span>
<span class="sd">            - DELETE request: Deletes a `DPI` record.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">DPI</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">DPISerializer</span></div>



<div class="viewcode-block" id="ProfileView">
<a class="viewcode-back" href="../../../docs/DPI.views.html#DPI.views.patients.ProfileView">[docs]</a>
<span class="k">class</span> <span class="nc">ProfileView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles requests related to a patient&#39;s profile and hospitalizations.</span>

<span class="sd">    This API view allows authenticated users to:</span>
<span class="sd">    - Retrieve detailed information about a patient&#39;s profile.</span>
<span class="sd">    - Fetch the patient&#39;s hospitalization history (sejours).</span>
<span class="sd">    - Generate a PDF certificate for a specific hospitalization if requested.</span>

<span class="sd">    Permissions:</span>
<span class="sd">        - Requires the user to be authenticated (`IsAuthenticated`).</span>

<span class="sd">    Methods:</span>
<span class="sd">        - `get(request, email, *args, **kwargs)`: Handles GET requests to retrieve the patient&#39;s profile and sejour information.</span>
<span class="sd">        - `generate_certificate(patient, sejours)`: Generates a PDF certificate for a patient&#39;s hospitalization.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The HTTP request object.</span>
<span class="sd">        email (str): The email address of the patient whose profile is being accessed.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Response:</span>
<span class="sd">            - On success: A JSON object containing patient details, hospitalization history, and an optional PDF certificate.</span>
<span class="sd">            - On failure: A JSON object with an error message and appropriate HTTP status.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>
<div class="viewcode-block" id="ProfileView.get">
<a class="viewcode-back" href="../../../docs/DPI.views.html#DPI.views.patients.ProfileView.get">[docs]</a>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the profile and hospitalization details of a patient based on their email.</span>

<span class="sd">        The profile includes general patient information, such as:</span>
<span class="sd">        - Date of birth</span>
<span class="sd">        - Status (active or not active)</span>
<span class="sd">        - Mutuelle (insurance)</span>
<span class="sd">        - Address</span>
<span class="sd">        - Social Security Number</span>
<span class="sd">        - Contact person details</span>
<span class="sd">        - List of hospitalizations (sejours)</span>

<span class="sd">        If the `generate_certificate` query parameter is set to `true`, a PDF certificate for the most recent hospitalization is generated.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (Request): The HTTP request object.</span>
<span class="sd">            email (str): The email address of the patient.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Response:</span>
<span class="sd">                - On success: A JSON object containing the patient&#39;s profile and sejour details.</span>
<span class="sd">                - On failure: A JSON object with an error message and an appropriate HTTP status code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Retrieve the logged-in user (patient)</span>
            <span class="n">patient</span> <span class="o">=</span> <span class="n">ComptePatient</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
            <span class="c1"># Fetch all sejours (hospitalizations) for the patient</span>
            <span class="n">sejours</span> <span class="o">=</span> <span class="n">Sejour</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">idDossierPatient</span><span class="o">=</span><span class="n">patient</span><span class="o">.</span><span class="n">dossierPatient</span><span class="o">.</span><span class="n">numeroSecuriteSociale</span><span class="p">)</span>

            <span class="c1"># Prepare patient profile data</span>
            <span class="n">general_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;date-of-birth&quot;</span><span class="p">:</span> <span class="n">patient</span><span class="o">.</span><span class="n">dossierPatient</span><span class="o">.</span><span class="n">dateDeNaissance</span><span class="p">,</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;not active&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mutuelle&quot;</span><span class="p">:</span><span class="n">patient</span><span class="o">.</span><span class="n">dossierPatient</span><span class="o">.</span><span class="n">mutuelle</span><span class="p">,</span>
                <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">patient</span><span class="o">.</span><span class="n">dossierPatient</span><span class="o">.</span><span class="n">adresse</span><span class="p">,</span>
                <span class="s2">&quot;Social-Security-Number&quot;</span><span class="p">:</span> <span class="n">patient</span><span class="o">.</span><span class="n">dossierPatient</span><span class="o">.</span><span class="n">numeroSecuriteSociale</span><span class="p">,</span>  
                <span class="s2">&quot;sejours&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;phone_number&quot;</span><span class="p">:</span> <span class="n">patient</span><span class="o">.</span><span class="n">dossierPatient</span><span class="o">.</span><span class="n">telephone</span><span class="p">,</span>
                <span class="s2">&quot;contact_person&quot;</span><span class="p">:</span> <span class="n">patient</span><span class="o">.</span><span class="n">dossierPatient</span><span class="o">.</span><span class="n">personneAcontacter</span>
            <span class="p">}</span>

            <span class="c1"># Add details about each sejour (stay)</span>
            <span class="k">for</span> <span class="n">sejour</span> <span class="ow">in</span> <span class="n">sejours</span><span class="p">:</span>
                <span class="n">sejour_info</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">sejour</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;start_date&quot;</span><span class="p">:</span> <span class="n">sejour</span><span class="o">.</span><span class="n">dateDebutSejour</span><span class="p">,</span>
                    <span class="s2">&quot;end_date&quot;</span><span class="p">:</span> <span class="n">sejour</span><span class="o">.</span><span class="n">dateFinSejour</span><span class="p">,</span>
                    <span class="s2">&quot;motifAdmission&quot;</span><span class="p">:</span> <span class="n">sejour</span><span class="o">.</span><span class="n">motifAdmission</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="n">sejour</span><span class="o">.</span><span class="n">dateDebutSejour</span> <span class="o">&lt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">sejour</span><span class="o">.</span><span class="n">dateFinSejour</span><span class="p">:</span>
                    <span class="n">general_info</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;active&quot;</span>  

                <span class="n">general_info</span><span class="p">[</span><span class="s2">&quot;sejours&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sejour_info</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;generate_certificate&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>  <span class="c1"># If the button is clicked</span>
               
                  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_certificate</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">sejours</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">general_info</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">ComptePatient</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Patient not found&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;An error occurred: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="ProfileView.generate_certificate">
<a class="viewcode-back" href="../../../docs/DPI.views.html#DPI.views.patients.ProfileView.generate_certificate">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_certificate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patient</span><span class="p">,</span> <span class="n">sejours</span><span class="p">):</span>
        <span class="c1"># Generate the PDF</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/pdf&#39;</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;inline; filename=&quot;certificate.pdf&quot;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">Canvas</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">pagesize</span><span class="o">=</span><span class="n">letter</span><span class="p">)</span>

        <span class="n">p</span><span class="o">.</span><span class="n">drawString</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">750</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Certificate of Hospitalization for </span><span class="si">{</span><span class="n">patient</span><span class="o">.</span><span class="n">nom</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">patient</span><span class="o">.</span><span class="n">prenom</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">drawString</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">730</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Date of Birth: </span><span class="si">{</span><span class="n">patient</span><span class="o">.</span><span class="n">dossierPatient</span><span class="o">.</span><span class="n">dateDeNaissance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">drawString</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">710</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Mutuelle: </span><span class="si">{</span><span class="n">patient</span><span class="o">.</span><span class="n">dossierPatient</span><span class="o">.</span><span class="n">mutuelle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Assuming the first sejour is the most recent</span>
        <span class="n">sejour</span> <span class="o">=</span> <span class="n">sejours</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">drawString</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">690</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Hospitalization Start Date: </span><span class="si">{</span><span class="n">sejour</span><span class="o">.</span><span class="n">dateDebutSejour</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">drawString</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">670</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Hospitalization End Date: </span><span class="si">{</span><span class="n">sejour</span><span class="o">.</span><span class="n">dateFinSejour</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">drawString</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">650</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Hospitalization Reason: </span><span class="si">{</span><span class="n">sejour</span><span class="o">.</span><span class="n">motifAdmission</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">p</span><span class="o">.</span><span class="n">showPage</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">response</span></div>
</div>


<div class="viewcode-block" id="get_patient_by_email">
<a class="viewcode-back" href="../../../docs/DPI.views.html#DPI.views.patients.get_patient_by_email">[docs]</a>
<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">get_patient_by_email</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve patient information based on the provided email address.</span>

<span class="sd">    This view accepts a GET request with an `email` parameter and returns the corresponding </span>
<span class="sd">    patient&#39;s details, including personal and contact information. It fetches data from </span>
<span class="sd">    the `ComptePatient` and related `DPI` models.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        request (HttpRequest): The HTTP request object, expected to contain an `email` parameter.</span>

<span class="sd">    Returns:</span>
<span class="sd">        JsonResponse: A JSON response containing patient details if the email exists.</span>
<span class="sd">        If the email is not provided or the patient is not found, an error response is returned.</span>

<span class="sd">    Example Usage:</span>
<span class="sd">        GET /get_patient_by_email?email=&lt;email&gt;</span>

<span class="sd">    Data Structure:</span>
<span class="sd">        - nomComplet (str): The full name of the patient.</span>
<span class="sd">        - dateDeNaissance (date): The date of birth of the patient.</span>
<span class="sd">        - adresse (str): The address of the patient.</span>
<span class="sd">        - telephone (str): The phone number of the patient.</span>
<span class="sd">        - numeroSecuriteSociale (str): The social security number of the patient.</span>
<span class="sd">        - personneAcontacter (str): The emergency contact person for the patient.</span>

<span class="sd">    Error Responses:</span>
<span class="sd">        - 400: When the `email` parameter is not provided.</span>
<span class="sd">        - 404: When no patient account is found for the provided email.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">email</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Fetch patient account by email</span>
            <span class="n">patient_account</span> <span class="o">=</span> <span class="n">ComptePatient</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
            <span class="c1"># Fetch the related DPI record</span>
            <span class="n">patient_dpi</span> <span class="o">=</span> <span class="n">patient_account</span><span class="o">.</span><span class="n">dossierPatient</span>
            
            <span class="c1"># Prepare data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;nomComplet&quot;</span><span class="p">:</span> <span class="n">patient_account</span><span class="o">.</span><span class="n">nomComplet</span><span class="p">,</span>
                <span class="s2">&quot;dateDeNaissance&quot;</span><span class="p">:</span> <span class="n">patient_dpi</span><span class="o">.</span><span class="n">dateDeNaissance</span><span class="p">,</span>
                <span class="s2">&quot;adresse&quot;</span><span class="p">:</span> <span class="n">patient_dpi</span><span class="o">.</span><span class="n">adresse</span><span class="p">,</span>
                <span class="s2">&quot;telephone&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">patient_dpi</span><span class="o">.</span><span class="n">telephone</span><span class="p">),</span>
                <span class="s2">&quot;numeroSecuriteSociale&quot;</span><span class="p">:</span> <span class="n">patient_dpi</span><span class="o">.</span><span class="n">numeroSecuriteSociale</span><span class="p">,</span>
                <span class="s2">&quot;personneAcontacter&quot;</span><span class="p">:</span> <span class="n">patient_dpi</span><span class="o">.</span><span class="n">personneAcontacter</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ComptePatient</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Patient not found&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Email is required&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span></div>


    

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, TpIglTeam5Groupe6.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>